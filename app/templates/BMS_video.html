<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BMS - Video Library</title>
  <link rel="stylesheet" href="/static/css/BMS_video.css">
  <style>
    /* Minimal CSS untuk layout grid (tambahan bisa dimasukkan ke file CSS) */
    body{font-family:Arial,Helvetica,sans-serif;background:#070707;color:#e6ffee;padding:18px}
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .btn{padding:8px 12px;border-radius:8px;background:#0f0f0f;border:1px solid #00ff7f;color:#00ff7f;cursor:pointer}
    .btn.warn{background:#1a0b00;border-color:#ff9900;color:#ffcc99}
    .library-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;margin-top:14px}
    .card{background:rgba(0,0,0,0.5);border:1px solid rgba(0,255,110,0.08);padding:10px;border-radius:8px}
    .thumb{width:100%;height:120px;object-fit:cover;border-radius:6px;background:#111}
    .meta{margin-top:8px;font-size:13px;color:#bfeed1}
    .meta .title{font-weight:700;color:#cfffde}
    .actions{margin-top:8px;display:flex;gap:6px}
    #playerModal{position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:none;align-items:center;justify-content:center;padding:20px}
    #playerBox{width:100%;max-width:900px}
    video{width:100%;height:auto;border-radius:8px;background:#000}
  </style>
</head>
<body>

<div class="topbar">
  <h2>üé¨ BMS Video Library</h2>
  <div>
    <button class="btn" onclick="loadLibrary()">Refresh</button>
    <button class="btn" onclick="scanDB()">üîç Scan Library</button>
  </div>
</div>

<div id="status" style="margin-top:10px;color:#aaffc2"></div>

<div id="library" class="library-grid"></div>

<!-- Player modal -->
<div id="playerModal">
  <div id="playerBox" class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div id="playerTitle"></div>
      <button class="btn" onclick="closePlayer()">Close</button>
    </div>
    <video id="playerVideo" controls></video>
  </div>
</div>

<script>
async function apiGET(path){ let r=await fetch(path); if(!r.ok) throw new Error(r.statusText); return await r.json(); }
async function loadLibrary(){
  try{
    document.getElementById("status").textContent="Memuat library..."
    let data = await apiGET("/video/library");
    const lib = document.getElementById("library");
    lib.innerHTML = "";
    if(!data || data.length===0){
      lib.innerHTML = "<div style='grid-column:1/-1'>Tidak ada video di library.</div>";
      document.getElementById("status").textContent = "";
      return;
    }
    data.forEach(v=>{
      const card=document.createElement("div"); card.className="card";
      // thumbnail route uses video id if present; fallback plain box
      const thumb = document.createElement("img");
      thumb.className="thumb";
      thumb.alt = v.filename;
      thumb.src = `/video/thumbnail/${v.id}`;
      // meta
      const meta=document.createElement("div"); meta.className="meta";
      meta.innerHTML = `<div class="title">${v.filename}</div><div style="font-size:12px;color:#9fffb1">${v.filepath}</div>`;
      // actions
      const actions=document.createElement("div"); actions.className="actions";
      const playBtn = document.createElement("button"); playBtn.className="btn"; playBtn.textContent="‚ñ∂ Play";
      playBtn.onclick = ()=> playVideo(v.id, v.filename);
      const delBtn = document.createElement("button"); delBtn.className="btn warn"; delBtn.textContent="üóë Hapus";
      delBtn.onclick = ()=> deleteFromLibrary(v.id);
      actions.appendChild(playBtn); actions.appendChild(delBtn);
      card.appendChild(thumb); card.appendChild(meta); card.appendChild(actions);
      lib.appendChild(card);
    });
    document.getElementById("status").textContent="";
  }catch(e){
    document.getElementById("status").textContent="Gagal memuat library.";
    console.error(e);
  }
}

async function scanDB(){
  if(!confirm("Scan seluruh storage dan tambahkan video ke library? Ini akan memindai banyak file.")) return;
  document.getElementById("status").textContent="Memulai scan... (sabar ya)";
  try{
    let res = await fetch("/video/scan-db",{method:"POST"});
    let data = await res.json();
    document.getElementById("status").textContent = data.message || "Selesai scan";
    loadLibrary();
  }catch(e){
    document.getElementById("status").textContent = "Gagal scan.";
    console.error(e);
  }
}

function playVideo(id, title){
  const modal = document.getElementById("playerModal");
  const player = document.getElementById("playerVideo");
  document.getElementById("playerTitle").textContent = title;
  player.src = `/video/play/${id}`;
  modal.style.display = "flex";
  player.play().catch(()=>{});
}

function closePlayer(){
  const modal = document.getElementById("playerModal");
  const player = document.getElementById("playerVideo");
  player.pause(); player.src = "";
  modal.style.display = "none";
}

async function deleteFromLibrary(id){
  if(!confirm("Hapus video dari library? (file fisik tidak akan dihapus)")) return;
  try{
    let res = await fetch(`/video/delete/${id}`,{method:"POST"});
    let data = await res.json();
    alert(data.message || "Selesai");
    loadLibrary();
  }catch(e){
    alert("Gagal hapus");
    console.error(e);
  }
}

// load otomatis
loadLibrary();
</script>

</body>
</html>